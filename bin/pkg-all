#!/usr/bin/env bash
## Run this from the project root

# This script invokes pkg-uberjar to build the uberjar, then creates a .tar.gz file containing the
# JAR file, a README with installation instructions, and a shell script for launching the tool (so
# that users don’t have to invoke `java` directly but also to give us an opportunity to set some
# important Java system properties).

set -eux -o pipefail

[[ -z "$FC4_VERSION" ]] && echo 'FC4_VERSION is not set!' && exit 1

# TODO: how risky is this, that we’ll end up packaging stale files? I think not *too* risky since
# we *should* be running this script in a fresh CI container!
if [ ! -f target/pkg/fc4.jar ]; then bin/pkg-uberjar; fi

pkg_dir="target/pkg/fc4"

mkdir -p $pkg_dir
cp target/pkg/fc4.jar \
   dist/* \
   $pkg_dir/

cp docs/tool/index.md $pkg_dir/README.md

archive="fc4-$FC4_VERSION.tar.gz"
(cd target/pkg && tar -czf "$archive" fc4/*)
echo "$archive"
